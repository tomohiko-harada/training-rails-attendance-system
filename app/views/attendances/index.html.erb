<header class="bg-dark py-5">
  <div class="container px-1 px-lg-5 my-2">
    <div class="text-center text-white">
      <h1 class="display-4 fw-bolder">打刻履歴</h1>
    </div>
  </div>
</header>

<div class="p-5">
  <div class="d-flex justify-content-start align-items-center mb-4">
    <%= form_with url: user_attendances_path(current_user), method: :get, local: true, class: "d-flex align-items-center" do %>
      <%= select_tag :year, options_for_select((2020..Time.current.year).to_a, @first_day.year), class: "form-select w-100 me-2" %>
      <span class="me-2">年</span>
      <%= select_tag :month, options_for_select((1..12).to_a, @first_day.month), class: "form-select w-50 me-2" %>
      <span class="me-2">月</span>
      <%= submit_tag "決定", class: "btn btn-primary" %>
    <% end %>
  </div>

  <table class="table table-bordered">
    <thead class="thead-dark table-dark">
      <tr>
        <th>日付</th>
        <th>曜日</th>
        <th>出社時刻</th>
        <th>退社時刻</th>
        <th>拘束時間</th>
        <th>休憩開始</th>
        <th>休憩終了</th>
        <th>休憩時間</th>
      </tr>
    </thead>
    <tbody>
      <% total_rest_time = 0 %>
      <% total_binding_time = 0 %>

      <% @calendar_data.each do |attendance| %>
        <% binding_time_minutes = 0 %>
        <% rest_time_minutes = 0 %>
        
        <% if attendance.persisted? %>
          <% if attendance.start_time && attendance.finish_time %>
            <% binding_time_minutes = (attendance.finish_time - attendance.start_time) / 60 %>
          <% end %>

          <% if attendance.start_rest_time && attendance.finish_rest_time %>
            <% rest_time_minutes = (attendance.finish_rest_time - attendance.start_rest_time) / 60 %>
          <% elsif attendance.start_rest_time.nil? && attendance.finish_time.present? %>
            <% rest_time_minutes = 60 # 休憩開始がない場合は1時間とみなす %>
          <% end %>
          
          <% total_binding_time += binding_time_minutes %>
          <% total_rest_time += rest_time_minutes %>
        <% end %>

        <tr>
          <td><%= l attendance.date, format: :short %></td>
          <td><%= I18n.t("date.abbr_day_names")[attendance.date.wday] %></td>
          <td><%= attendance.start_time&.strftime(t('time.formats.punch_time')) %></td>
          <td><%= attendance.finish_time&.strftime(t('time.formats.punch_time')) %></td>
          <td><%= number_to_hours(binding_time_minutes) %></td>
          <td><%= attendance.start_rest_time&.strftime(t('time.formats.punch_time')) %></td>
          <td><%= attendance.finish_rest_time&.strftime(t('time.formats.punch_time')) %></td>
          <td><%= number_to_hours(rest_time_minutes) %></td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <h3 class="p-3">合計</h3>

  <table class="table table-bordered w-50">
    <thead class="thead-dark table-dark">
      <tr>
        <th>拘束時間</th>
        <th>休憩時間</th>
        <th>合計時間</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><%= number_to_hours(total_binding_time) %></td>
        <td><%= number_to_hours(total_rest_time) %></td>
        <td><%= number_to_hours(total_binding_time - total_rest_time) %></td>
      </tr>
    </tbody>

</div>