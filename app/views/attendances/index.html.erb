<% content_for :description do %>
  <%= "ユーザーの月間勤怠履歴を閲覧できるページです。" %>
<% end %>

<header class="bg-dark py-5">
  <div class="container px-lg-5 my-1">
    <div class="text-center text-white">
      <h1 class="display-4 fw-bolder">打刻履歴</h1>
    </div>
  </div>
</header>

<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="d-flex justify-content-start align-items-center mb-4">
        <%= form_with url: user_attendances_path(current_user), method: :get, local: true, class: "d-flex align-items-center" do %>
          <%= select_tag :year, options_for_select((2020..Time.current.year).to_a, @first_day.year), class: "form-select w-100 me-2" %>
          <span class="me-2">年</span>
          <%= select_tag :month, options_for_select((1..12).to_a, @first_day.month), class: "form-select w-50 me-2" %>
          <span class="me-2">月</span>
          <%= submit_tag "決定", class: "btn btn-primary" %>
        <% end %>
        <div class="ms-auto me-3">
          <%= link_to "打刻画面に戻る", user_path(current_user), class: "btn btn-outline-danger"%>
        </div>
      </div>

      <table class="table table-bordered">
        <thead class="thead-dark table-dark">
          <tr>
            <th>日付</th>
            <th>曜日</th>
            <th>出社時刻</th>
            <th>退社時刻</th>
            <th>拘束時間</th>
            <th>休憩開始</th>
            <th>休憩終了</th>
            <th>休憩時間</th>
          </tr>
        </thead>
        <tbody>
          <% total_rest_time = 0 %>
          <% total_binding_time = 0 %>

          <% @calendar_data.each do |attendance| %>
            <% binding_time_minutes = 0 %>
            <% rest_time_minutes = 0 %>
            
            <% if attendance.persisted? %>
              <% if attendance.started_at && attendance.finished_at %>
                <% binding_time_minutes = (attendance.finished_at - attendance.started_at) / 60 %>
              <% end %>

              <% if attendance.started_rest_at && attendance.finished_rest_at %>
                <% rest_time_minutes = (attendance.finished_rest_at - attendance.started_rest_at) / 60 %>
              <% elsif attendance.started_rest_at.nil? && attendance.finished_at.present? %>
                <% rest_time_minutes = 60 # 休憩開始がない場合は1時間とみなす %>
              <% end %>
              
              <% total_binding_time += binding_time_minutes %>
              <% total_rest_time += rest_time_minutes %>
            <% end %>
            
            <%# 日付と曜日の列に動的にクラスを付与 %>
            <% day_class = case attendance.date_on.wday %>
                          <% when 6 then "text-primary" # 土曜日は青色 %>
                          <% when 0 then "text-danger" # 日曜日は赤色 %>
                          <% else %>
                            <% HolidayJp.holiday?(attendance.date_on) ? "text-danger" : "" %>
                          <% end %>

            <tr>
              <td class="<%= day_class %> fw-bold"><%= l attendance.date_on, format: :short %></td>
              <td class="<%= day_class %> fw-bold"><%= I18n.t("date.abbr_day_names")[attendance.date_on.wday] %></td>
              <td><%= attendance.started_at&.strftime(t('time.formats.punch_time')) %></td>
              <td><%= attendance.finished_at&.strftime(t('time.formats.punch_time')) %></td>
              <td><%= number_to_hours(binding_time_minutes) if attendance.persisted? %></td>
              <td><%= attendance.started_rest_at&.strftime(t('time.formats.punch_time')) %></td>
              <td><%= attendance.finished_rest_at&.strftime(t('time.formats.punch_time')) %></td>
              <td><%= number_to_hours(rest_time_minutes) if attendance.persisted? %></td>
            </tr>
          <% end %>
        </tbody>
      </table>

      <h2 class="p-3">合計</h3>

      <table class="table table-bordered w-50">
        <thead class="thead-dark table-dark">
          <tr>
            <th>拘束時間</th>
            <th>休憩時間</th>
            <th>労働時間</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><%= number_to_hours(total_binding_time) %></td>
            <td><%= number_to_hours(total_rest_time) %></td>
            <td><%= number_to_hours(total_binding_time - total_rest_time) %></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>